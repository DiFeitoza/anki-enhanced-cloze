<div id="card-body">
    <div id="domain-and-topic-section" class="content">
        {{#Domain}}
        <div id="domain">@ {{Domain}}</div>
        {{/Domain}}

        <!-- 分割线 -->
        {{#Topic}}
        <div id="topic"># {{Topic}}</div>
        {{/Topic}}

    </div>

    <div id="main-section" class="content">
        <!-- 分割线 -->
        {{cloze:Cloze99}}
        <!-- 分割线 -->
        {{cloze:Cloze1}}
        <!-- 分割线 -->
        {{cloze:Cloze2}}
        <!-- 分割线 -->
        {{cloze:Cloze3}}
        <!-- 分割线 -->
        {{cloze:Cloze4}}
        <!-- 分割线 -->
        {{cloze:Cloze5}}
        <!-- 分割线 -->
        {{cloze:Cloze6}}
        <!-- 分割线 -->
        {{cloze:Cloze7}}
        <!-- 分割线 -->
        {{cloze:Cloze8}}
        <!-- 分割线 -->
        {{cloze:Cloze9}}
        <!-- 分割线 -->
        {{cloze:Cloze10}}
        <!-- 分割线 -->
        {{cloze:Cloze11}}
        <!-- 分割线 -->
        {{cloze:Cloze12}}
        <!-- 分割线 -->
        {{cloze:Cloze13}}
        <!-- 分割线 -->
        {{cloze:Cloze14}}
        <!-- 分割线 -->
        {{cloze:Cloze15}}
        <!-- 分割线 -->
        {{cloze:Cloze16}}
        <!-- 分割线 -->
        {{cloze:Cloze17}}
        <!-- 分割线 -->
        {{cloze:Cloze18}}
        <!-- 分割线 -->
        {{cloze:Cloze19}}
        <!-- 分割线 -->
        {{cloze:Cloze20}}
    </div>
    <br>

    <div id="info-section">
        <div id="info-header" class="header left-border-red text-color-red" onclick="showNextElement(this)">
            <b>信息</b>
        </div>

        <div id="info" class="content" style="display:none">
            <div>牌组：
                <b>{{Deck}}</b>
            </div>

            <!-- 分割线 -->
            {{#Project}}
            <div>项目：
                <b>{{Project}}</b>
            </div>
            {{/Project}}

            <!-- 分割线  -->
            {{#Tags}}
            <div id="tags">标签：
                <b>{{Tags}}</b>
            </div>
            {{/Tags}}

            <!-- 分割线  -->
            {{#Subject}}
            <div>主题：
                <b>{{Subject}}</b>
            </div>
            {{/Subject}}
        </div>
        <br>
    </div>

    <!-- 分割线  -->
    {{#Source}}
    <div id="source-section">
        <div id="source-header" class="header left-border-green text-color-green" onclick="showNextElement(this)">
            来源
        </div>
        <div id="source" class="content" style="display:none">
            {{Source}}
        </div>
    </div>
    <br> {{/Source}}

    <!-- 分割线 -->
    {{#Extra}}
    <div id="extra-section">
        <div id="extra-header" class="header left-border-blue text-color-blue" onclick="showNextElement(this)">
            补充
        </div>
        <div id="extra" class="content" style="display:none">
            {{Extra}}
        </div>
    </div>
    <br> {{/Extra}}

    <div id="show-one-cloze-left"></div>
    <div id="show-one-cloze-right"></div>
    <div id="no-more-cloze"></div>
</div>

<script src="_jquery-3.2.1.min.js"></script>
<script src="_jquery.hotkeys.js"></script>
<script src="_Autolinker.min.js"></script>
<script src="_jquery.visible.min.js"></script>

<script>
    var indexOfGenuineClozeToShow = 0;
    var genuineClozeTotalNumber = $('.genuine-cloze').length;

    $(function () {
        // initialize genuine clozes
        $('.genuine-cloze').each(function (index, elem) {
            toggleCloze($(this), 'hint')
        });

        // initialize pseudo clozes
        $('.pseudo-cloze').each(function (index, elem) {
            toggleCloze($(this), 'hint')
        });

        // initialize hidden block
        $('.hidden-block').each(function (index, elem) {
            $(elem).html('&nbsp;&nbsp;[&nbsp;&nbsp;点击显示&nbsp;&nbsp;]&nbsp;&nbsp;')
        })

        // shorten tags
        $('#tags kbd').each(function (index, elem) {
            $(elem).text($(elem).text().replace(/[^:\s]+::/g, ''));
        });

        var cardBodyElem = document.getElementById('card-body')
        cardBodyElem.innerHTML = Autolinker.link(cardBodyElem.innerHTML, {
            phone: false,
            truncate: {
                length: 100,
                location: 'smart'
            },
            stripPrefix: false,
        });

        scrollToFirstCloze();

        // setup key binding
        $(document).bind('keyup', 'i', function () {
            showOneCloze();
        })

        // setup hidden block click event
        $('.hidden-block').click(function () {
            showHiddenBlock(this);
        })

        // setup cloze click event
        $('.genuine-cloze, .pseudo-cloze').click(function () {
            toggleCloze($(this), 'toggle');
        })

        $('#show-one-cloze-left,#show-one-cloze-right').click(function () {
            showOneCloze();
        })
    });

    function scrollToFirstCloze() {
        scrollToCloze($('.genuine-cloze').first(), true);
    }

    function scrollToCloze($elem, isFirst) {
        if (isFirst) {
            $('html, body').animate({
                scrollTop: $elem.offset().top - 200
            }, 100);
        } else if (!$elem.visible()) {
            $('html, body').animate({
                scrollTop: $elem.offset().top - 200
            }, 100);

            // var windowScrollTop = $(window).scrollTop();
            // var elemOffsetTop = $elem.offset().top;
            // if ((elemOffsetTop - windowScrollTop) < 300) {
            //     $('html, body').animate({
            //         scrollTop: $(window).scrollTop - 300,
            //     }, 100);
            // }
        }
    }

    function showHiddenBlock(elem) {
        $(elem).html($('#hidden-block-' + $(elem).attr('index')).html());
    }

    function padHint(elem) {
        var index = $(elem).attr('index');
        var isGenuine = ($(elem).hasClass('genuine-cloze')) ? true : false;
        var oriHint = '';
        if (isGenuine) {
            oriHint = $('#genuine-hint-' + index).html();
        } else {
            oriHint = $('#pseudo-hint-' + index).html();
        }
        if (oriHint == '') {
            hint = '&nbsp;&nbsp;[&nbsp;&nbsp;&nbsp;&nbsp;]&nbsp;&nbsp;'
        } else {
            hint = '&nbsp;&nbsp;[&nbsp;&nbsp;' + oriHint + '&nbsp;&nbsp;]&nbsp;&nbsp;'
        }
        return hint;
    }

    function showOneCloze() {
        if (indexOfGenuineClozeToShow >= genuineClozeTotalNumber) {
            $('#no-more-cloze').animate({
                display: "toggle",
            }, 500);
        } else {
            $('.genuine-cloze[index=' + (indexOfGenuineClozeToShow++) + ']').each(function (index, elem) {
                toggleCloze(elem, 'answer');
                scrollToCloze($(elem));
                $(elem).css('display', 'none');
                $(elem).show(500);
            })
        }
    }

    function toggleCloze(elem, displayOption) {
        var answer, hint;
        if ($(elem).hasClass('genuine-cloze')) {
            answer = $('#genuine-answer-' + $(elem).attr('index')).html();
            hint = padHint(elem);
        } else {
            answer = $('#pseudo-answer-' + $(elem).attr('index')).html();
            hint = padHint(elem);
        }

        if (displayOption == 'answer') {
            $(elem).attr('show-state', 'answer');
            $(elem).html(answer);
        } else if (displayOption == 'hint') {
            $(elem).attr('show-state', 'hint');
            $(elem).html(hint);
        } else if (displayOption == 'toggle') {
            if ($(elem).attr('show-state') == 'hint') {
                $(elem).attr('show-state', 'answer');
                $(elem).html(answer);
            } else {
                $(elem).attr('show-state', 'hint');
                $(elem).html(hint);
            };
        };
    }

    function showNextElement(elem) {
        showElement($(elem).next());
    };

    function showElement(elem) {
        $(elem).show();
    };
</script>